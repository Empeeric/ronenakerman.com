<!DOCTYPE html><html lang="en"><head><title>lib\MongooseAdmin</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="lib\MongooseAdmin"><meta name="groc-project-path" content="lib\MongooseAdmin.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">lib\MongooseAdmin.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;lodash&#39;</span><span class="p">),</span>
    <span class="nx">async</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;async&#39;</span><span class="p">),</span>
    <span class="nx">formage</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">),</span>
    <span class="nx">Users</span> <span class="o">=</span> <span class="nx">formage</span><span class="p">.</span><span class="nx">models</span><span class="p">.</span><span class="nx">MongooseAdminUser</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>MongooseAdminAudit = formage.models.MongooseAdminAudit,</p></div></div><div class="code"><div class="wrapper">    <span class="nx">AdminForm</span> <span class="o">=</span> <span class="nx">formage</span><span class="p">.</span><span class="nx">AdminForm</span><span class="p">,</span>
    <span class="nx">dependencies</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./dependencies&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> api private</span></p>

<p>MongooseAdmin Constructor</p></div></div><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">MongooseAdmin</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">MongooseAdmin</span><span class="p">.</span><span class="nx">defaults</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">root</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">root</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">root</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">app</span> <span class="o">=</span> <span class="nx">app</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">models</span> <span class="o">=</span> <span class="p">{};</span>
<span class="p">};</span>


<span class="nx">MongooseAdmin</span><span class="p">.</span><span class="nx">defaults</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Backoffice&#39;</span><span class="p">,</span>
    <span class="nx">root</span><span class="o">:</span> <span class="s1">&#39;/admin&#39;</span><span class="p">,</span>
    <span class="nx">default_section</span><span class="o">:</span> <span class="s1">&#39;Main&#39;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>Build a full path that can be used in a URL</p>

<p>Parameters:</p>

<ul>
<li><strong>path must be a String.</strong></li>
</ul></div></div><div class="code"><div class="wrapper"><span class="nx">MongooseAdmin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">buildPath</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">root</span> <span class="o">+</span> <span class="p">(</span><span class="nx">path</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">MongooseAdmin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getAdminTitle</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">MongooseAdmin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setAdminTitle</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">title</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">title</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> api public</span></p>

<p>Stop listening and end the admin process</p></div></div><div class="code"><div class="wrapper"><span class="nx">MongooseAdmin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">close</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">buildModelFilters_fireAndForget</span> <span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">filters</span><span class="p">,</span> <span class="nx">dict</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">filters</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">filters</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">filter</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">schema</span><span class="p">.</span><span class="nx">paths</span><span class="p">[</span><span class="nx">filter</span><span class="p">];</span>
            <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">path</span> <span class="o">&amp;&amp;</span> <span class="nx">path</span><span class="p">.</span><span class="nx">options</span><span class="p">;</span>
            <span class="nx">model</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">distinct</span><span class="p">(</span><span class="nx">filter</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">results</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
                <span class="nx">results</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">flatten</span><span class="p">(</span><span class="nx">results</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">)</span> <span class="nx">results</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">ref</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">dict</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
                        <span class="nx">key</span><span class="o">:</span> <span class="nx">filter</span><span class="p">,</span>
                        <span class="nx">isString</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="nb">String</span><span class="p">,</span>
                        <span class="nx">values</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="p">{</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="nx">result</span> <span class="p">};})</span>
                    <span class="p">});</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="nx">formage</span><span class="p">.</span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">ref</span><span class="p">).</span><span class="nx">find</span><span class="p">().</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">).</span><span class="k">in</span><span class="p">(</span><span class="nx">results</span><span class="p">).</span><span class="nx">exec</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">refs</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">refs</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
                    <span class="nx">dict</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
                        <span class="nx">key</span><span class="o">:</span> <span class="nx">filter</span><span class="p">,</span>
                        <span class="nx">isString</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                        <span class="nx">values</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">refs</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ref</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">{</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">ref</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span> <span class="nx">ref</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="p">};</span> <span class="p">})</span>
                    <span class="p">});</span>
                <span class="p">});</span>
            <span class="p">});</span>
        <span class="p">})</span>
    <span class="p">});</span>
<span class="p">}</span>


<span class="nx">MongooseAdmin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">registerMongooseModel</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">models</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">models</span><span class="p">;</span>

    <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">actions</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">actions</span> <span class="o">||</span> <span class="p">[];</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">actions</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
        <span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;delete&#39;</span><span class="p">,</span>
        <span class="nx">label</span><span class="o">:</span> <span class="s1">&#39;Delete&#39;</span><span class="p">,</span>
        <span class="nx">func</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">ids</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//noinspection JSUnresolvedFunction</span>
            <span class="nx">async</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span>
                <span class="nx">ids</span><span class="p">,</span>
                <span class="nx">_</span><span class="p">.</span><span class="nx">partial</span><span class="p">(</span><span class="nx">dependencies</span><span class="p">.</span><span class="nx">check</span><span class="p">,</span> <span class="nx">models</span><span class="p">,</span> <span class="nx">name</span><span class="p">),</span>
                <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
                    <span class="nx">results</span> <span class="o">=</span> <span class="nx">_</span><span class="p">(</span><span class="nx">results</span><span class="p">).</span><span class="nx">compact</span><span class="p">().</span><span class="nx">object</span><span class="p">().</span><span class="nx">valueOf</span><span class="p">();</span>
                    <span class="kd">var</span> <span class="nx">with_deps</span> <span class="o">=</span> <span class="nx">ids</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">id</span> <span class="k">in</span> <span class="nx">results</span><span class="p">;});</span>
                    <span class="kd">var</span> <span class="nx">no_dependencies</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">difference</span><span class="p">(</span><span class="nx">ids</span><span class="p">,</span> <span class="nx">with_deps</span><span class="p">);</span>
                    <span class="k">return</span> <span class="nx">model</span><span class="p">.</span><span class="nx">remove</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;$in&#39;</span><span class="o">:</span> <span class="nx">no_dependencies</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">err</span> <span class="o">=</span> <span class="nx">err</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="nx">with_deps</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;can&#39;t delete &quot;</span> <span class="o">+</span> <span class="nx">with_deps</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; as they have dependencies&quot;</span><span class="p">);</span>
                        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span>
                    <span class="p">});</span>
                <span class="p">}</span>
            <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">registerModel</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
<span class="p">};</span>


<span class="nx">MongooseAdmin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">registerSingleRowModel</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">model</span><span class="p">.</span><span class="nx">is_single</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">registerModel</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
<span class="p">};</span>


<span class="nx">MongooseAdmin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">registerModel</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">filters</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">buildModelFilters_fireAndForget</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">filters</span><span class="p">,</span> <span class="nx">filters</span><span class="p">);</span>
    <span class="nx">model</span><span class="p">.</span><span class="nx">label</span> <span class="o">=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">label</span> <span class="o">||</span> <span class="nx">name</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">+</span> <span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/_/g</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">form</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">form</span> <span class="o">||</span> <span class="nx">AdminForm</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">models</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">model</span><span class="o">:</span> <span class="nx">model</span><span class="p">,</span>
        <span class="nx">filters</span><span class="o">:</span> <span class="nx">filters</span><span class="p">,</span>
        <span class="nx">modelName</span><span class="o">:</span> <span class="nx">name</span><span class="p">,</span>
        <span class="nx">options</span><span class="o">:</span> <span class="nx">options</span><span class="p">,</span>
        <span class="nx">label</span> <span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">label</span> <span class="o">||</span> <span class="nx">model</span><span class="p">.</span><span class="nx">label</span><span class="p">,</span>
        <span class="nx">fields</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">fields</span><span class="p">,</span>
        <span class="nx">is_single</span><span class="o">:</span> <span class="nx">model</span><span class="p">.</span><span class="nx">is_single</span>
    <span class="p">};</span>
    <span class="nx">Users</span><span class="p">.</span><span class="nx">registerModelPermissions</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;\x1b[36mformage:\x1b[0m %s&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">MongooseAdmin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">renderUserPanel</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">cbk</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">admin_user</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">html</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;&lt;div&gt;Hello &#39;</span><span class="o">+</span> <span class="nx">user</span><span class="p">.</span><span class="nx">username</span>  <span class="o">+</span> <span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">lastVisit</span> <span class="o">?</span> <span class="s1">&#39;, your last visit was on &#39;</span> <span class="o">+</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">lastVisit</span><span class="p">).</span><span class="nx">toLocaleDateString</span><span class="p">()</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span> <span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&lt;/div&gt;&#39;</span>
    <span class="p">];</span>
    <span class="nx">cbk</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">html</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">));</span>
<span class="p">};</span>

<span class="nx">MongooseAdmin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getRegisteredModels</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">raw_models</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">models</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">out_models</span> <span class="o">=</span> <span class="nx">_</span><span class="p">(</span><span class="nx">raw_models</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">out_model</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">out_model</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">is_single</span> <span class="o">=</span> <span class="nx">out_model</span><span class="p">.</span><span class="nx">is_single</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">out_model</span><span class="p">;</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">out_model</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//noinspection JSUnresolvedVariable</span>
            <span class="k">return</span> <span class="nx">user</span><span class="p">.</span><span class="nx">hasPermissions</span><span class="p">(</span><span class="nx">out_model</span><span class="p">.</span><span class="nx">modelName</span><span class="p">,</span> <span class="s1">&#39;view&#39;</span><span class="p">)</span>
                <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">out_model</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">hideFromMain</span><span class="p">;</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nx">compact</span><span class="p">().</span><span class="nx">valueOf</span><span class="p">();</span>
    <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">out_models</span><span class="p">);</span>
<span class="p">};</span>


<span class="nx">MongooseAdmin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getModelConfig</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">collectionName</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">models</span><span class="p">[</span><span class="nx">collectionName</span><span class="p">]</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">models</span><span class="p">[</span><span class="nx">collectionName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()];</span>
<span class="p">};</span>


<span class="nx">MongooseAdmin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">modelCounts</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">collectionName</span><span class="p">,</span><span class="nx">filters</span><span class="p">,</span> <span class="nx">onReady</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">models</span><span class="p">[</span><span class="nx">collectionName</span><span class="p">].</span><span class="nx">is_single</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">onReady</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">models</span><span class="p">[</span><span class="nx">collectionName</span><span class="p">].</span><span class="nx">model</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">models</span><span class="p">[</span><span class="nx">collectionName</span><span class="p">].</span><span class="nx">model</span><span class="p">.</span><span class="nx">count</span><span class="p">(</span><span class="nx">filters</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">count</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Unable to get counts for model because: &#39;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
            <span class="nx">onReady</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">onReady</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">count</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">mongooseSort</span><span class="p">(</span><span class="nx">query</span><span class="p">,</span><span class="nx">sort</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">formage</span><span class="p">.</span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">version</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">sort</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="nx">query</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="nx">sort</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="s1">&#39;descending&#39;</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="nx">query</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="nx">sort</span><span class="p">,</span><span class="s1">&#39;ascending&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
        <span class="nx">query</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="nx">sort</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">MongooseAdmin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">listModelDocuments</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">collectionName</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">count</span><span class="p">,</span> <span class="nx">filters</span><span class="p">,</span> <span class="nx">sort</span><span class="p">,</span> <span class="nx">onReady</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">model_config</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">models</span><span class="p">[</span><span class="nx">collectionName</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="nx">model_config</span><span class="p">.</span><span class="nx">model</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">filters</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">sorts</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">model_config</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">order_by</span><span class="p">)</span> <span class="o">||</span> <span class="p">[];</span>
    <span class="kd">var</span> <span class="nx">populates</span> <span class="o">=</span> <span class="nx">model_config</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">list_populate</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">listFields</span> <span class="o">=</span> <span class="nx">model_config</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">list</span> <span class="o">||</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">sort</span><span class="p">)</span>
        <span class="nx">sorts</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">sort</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">sorts</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">sorts</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
            <span class="nx">mongooseSort</span><span class="p">(</span><span class="nx">query</span><span class="p">,</span> <span class="nx">sorts</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">populates</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">populates</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">populate</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">query</span><span class="p">.</span><span class="nx">populate</span><span class="p">(</span><span class="nx">populate</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">query</span><span class="p">.</span><span class="nx">skip</span><span class="p">(</span><span class="nx">start</span><span class="p">).</span><span class="nx">limit</span><span class="p">(</span><span class="nx">count</span><span class="p">).</span><span class="nx">exec</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">documents</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Unable to get documents for model because: &#39;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
            <span class="nx">onReady</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">[]);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">filteredDocuments</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="nx">documents</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nb">document</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="p">{};</span>
                <span class="nx">d</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">document</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">];</span>
                <span class="nx">listFields</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">listField</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">d</span><span class="p">[</span><span class="nx">listField</span><span class="p">]</span> <span class="o">=</span> <span class="k">typeof</span><span class="p">(</span><span class="nb">document</span><span class="p">[</span><span class="nx">listField</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span> <span class="o">?</span> <span class="nb">document</span><span class="p">[</span><span class="nx">listField</span><span class="p">]()</span> <span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">listField</span><span class="p">);</span>
                <span class="p">});</span>
                <span class="nx">filteredDocuments</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span>
            <span class="p">});</span>

            <span class="nx">onReady</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">filteredDocuments</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">};</span>


<span class="nx">MongooseAdmin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">createDocument</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">collectionName</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">onReady</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">models</span><span class="p">[</span><span class="nx">collectionName</span><span class="p">].</span><span class="nx">model</span><span class="p">;</span>
    <span class="c1">//noinspection LocalVariableNamingConventionJS</span>
    <span class="kd">var</span> <span class="nx">FormType</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">models</span><span class="p">[</span><span class="nx">collectionName</span><span class="p">].</span><span class="nx">options</span><span class="p">.</span><span class="nx">form</span> <span class="o">||</span> <span class="nx">AdminForm</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">.</span><span class="nx">hasPermissions</span><span class="p">(</span><span class="nx">collectionName</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">))</span> <span class="k">return</span> <span class="nx">onReady</span><span class="p">(</span><span class="s1">&#39;unauthorizaed&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">form</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FormType</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="p">{</span><span class="nx">data</span><span class="o">:</span> <span class="nx">params</span><span class="p">},</span> <span class="nx">model</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">form</span><span class="p">.</span><span class="nx">is_valid</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">valid</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">onReady</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">valid</span><span class="p">)</span> <span class="k">return</span> <span class="nx">onReady</span><span class="p">(</span><span class="nx">form</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">form</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nb">document</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">onReady</span><span class="p">(</span><span class="nx">form</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">models</span><span class="p">[</span><span class="nx">collectionName</span><span class="p">].</span><span class="nx">options</span> <span class="o">&amp;&amp;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">models</span><span class="p">[</span><span class="nx">collectionName</span><span class="p">].</span><span class="nx">options</span><span class="p">.</span><span class="nx">post</span><span class="p">)</span> <span class="p">{</span>
                <span class="nb">document</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">models</span><span class="p">[</span><span class="nx">collectionName</span><span class="p">].</span><span class="nx">options</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nb">document</span><span class="p">);</span>
            <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><pre><code>     MongooseAdminAudit.logActivity(user, self.models[collectionName].modelName, collectionName, document._id, 'add', null, function(err, auditLog) {
</code></pre></div></div><div class="code"><div class="wrapper">            <span class="k">return</span> <span class="nx">onReady</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nb">document</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><pre><code>     });
</code></pre></div></div><div class="code"><div class="wrapper">        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">};</span>


<span class="nx">MongooseAdmin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">updateDocument</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">collectionName</span><span class="p">,</span> <span class="nx">documentId</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">onReady</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
        <span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">models</span><span class="p">[</span><span class="nx">collectionName</span><span class="p">].</span><span class="nx">model</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">.</span><span class="nx">hasPermissions</span><span class="p">(</span><span class="nx">collectionName</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">))</span> <span class="k">return</span> <span class="nx">onReady</span><span class="p">(</span><span class="s1">&#39;unauthorized&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">FormType2</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">models</span><span class="p">[</span><span class="nx">collectionName</span><span class="p">].</span><span class="nx">options</span><span class="p">.</span><span class="nx">form</span> <span class="o">||</span> <span class="nx">AdminForm</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">model</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">documentId</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nb">document</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">onReady</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">form</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FormType2</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="p">{</span> <span class="nx">instance</span><span class="o">:</span> <span class="nb">document</span><span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">params</span> <span class="p">},</span> <span class="nx">model</span><span class="p">);</span>
        <span class="nx">form</span><span class="p">.</span><span class="nx">init_fields</span><span class="p">();</span>
        <span class="k">return</span> <span class="nx">form</span><span class="p">.</span><span class="nx">is_valid</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">valid</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="o">||</span> <span class="o">!</span><span class="nx">valid</span><span class="p">)</span> <span class="k">return</span> <span class="nx">onReady</span><span class="p">(</span><span class="nx">err</span> <span class="o">||</span> <span class="nx">form</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
            <span class="k">return</span> <span class="nx">form</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nb">document</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">onReady</span><span class="p">(</span><span class="nx">form</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">models</span><span class="p">[</span><span class="nx">collectionName</span><span class="p">].</span><span class="nx">options</span> <span class="o">&amp;&amp;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">models</span><span class="p">[</span><span class="nx">collectionName</span><span class="p">].</span><span class="nx">options</span><span class="p">.</span><span class="nx">post</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nb">document</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">models</span><span class="p">[</span><span class="nx">collectionName</span><span class="p">].</span><span class="nx">options</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nb">document</span><span class="p">);</span>
                <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>MongooseAdminAudit.logActivity(user, self.models[collectionName].modelName, collectionName, document._id, 'edit', null, function(err, auditLog) {</p></div></div><div class="code"><div class="wrapper">                <span class="k">return</span> <span class="nx">onReady</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nb">document</span><span class="p">);</span>
                <span class="c1">// );</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">};</span>


<span class="nx">MongooseAdmin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">deleteDocument</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">collectionName</span><span class="p">,</span> <span class="nx">documentId</span><span class="p">,</span> <span class="nx">onReady</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">models</span><span class="p">[</span><span class="nx">collectionName</span><span class="p">].</span><span class="nx">model</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">.</span><span class="nx">hasPermissions</span><span class="p">(</span><span class="nx">collectionName</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">))</span> <span class="k">return</span> <span class="nx">onReady</span><span class="p">(</span><span class="s1">&#39;unauthorized&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">model</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">documentId</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nb">document</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">onReady</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">document</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">onReady</span><span class="p">(</span><span class="s1">&#39;Document not found&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">dependencies</span><span class="p">.</span><span class="nx">unlink</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">models</span><span class="p">,</span> <span class="nx">collectionName</span><span class="p">,</span> <span class="nx">documentId</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">onReady</span><span class="p">(</span><span class="s1">&#39;unlink dependencies failed&#39;</span><span class="p">);</span>
            <span class="nb">document</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><pre><code>     MongooseAdminAudit.logActivity(user, self.models[collectionName].modelName, collectionName, documentId, 'del', null, function(err, auditLog) {
</code></pre></div></div><div class="code"><div class="wrapper">            <span class="k">return</span> <span class="nx">onReady</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><pre><code>     });
</code></pre></div></div><div class="code"><div class="wrapper">        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">};</span>


<span class="nx">MongooseAdmin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">orderDocuments</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">collectionName</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">.</span><span class="nx">hasPermissions</span><span class="p">(</span><span class="nx">collectionName</span><span class="p">,</span> <span class="s1">&#39;order&#39;</span><span class="p">))</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="s1">&#39;unauthorized&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">models</span><span class="p">[</span><span class="nx">collectionName</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">sorting_attr</span> <span class="o">=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">sortable</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">sorting_attr</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">();</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">data</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">set_dict</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="nx">set_dict</span><span class="p">[</span><span class="nx">sorting_attr</span><span class="p">]</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
        <span class="nx">model</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">id</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;$set&#39;</span><span class="o">:</span> <span class="nx">set_dict</span><span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span> <span class="p">{});</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">callback</span><span class="p">();</span>
<span class="p">};</span>


<span class="nx">MongooseAdmin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">actionDocuments</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">collectionName</span><span class="p">,</span> <span class="nx">actionId</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">onReady</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">.</span><span class="nx">hasPermissions</span><span class="p">(</span><span class="nx">collectionName</span><span class="p">,</span> <span class="s1">&#39;action&#39;</span><span class="p">))</span> <span class="k">return</span> <span class="nx">onReady</span><span class="p">(</span><span class="s1">&#39;unauthorized&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">action</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">models</span><span class="p">[</span><span class="nx">collectionName</span><span class="p">].</span><span class="nx">options</span><span class="p">.</span><span class="nx">actions</span><span class="p">,</span> <span class="p">{</span><span class="nx">value</span><span class="o">:</span> <span class="nx">actionId</span><span class="p">});</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">action</span><span class="p">)</span> <span class="k">return</span> <span class="nx">onReady</span><span class="p">(</span><span class="s1">&#39;no action&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">action</span><span class="p">.</span><span class="nx">func</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">ids</span><span class="p">,</span> <span class="nx">onReady</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> api private</span></p>

<p>Deserialize a user from a session store object</p>

<p>Parameters:</p>

<ul>
<li><strong>sessionStore must be an Object.</strong></li>
</ul></div></div><div class="code"><div class="wrapper"><span class="nx">MongooseAdmin</span><span class="p">.</span><span class="nx">userFromSessionStore</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sessionStore</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">sessionStore</span> <span class="o">?</span> <span class="nx">Users</span><span class="p">.</span><span class="nx">fromSessionStore</span><span class="p">(</span><span class="nx">sessionStore</span><span class="p">)</span> <span class="o">:</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> api public</span></p>

<p>Create an admin user account</p>

<p>Parameters:</p>

<ul>
<li><p><strong>username must be a String.</strong></p></li>
<li><p><strong>password must be a String.</strong></p></li>
</ul></div></div><div class="code"><div class="wrapper"><span class="nx">MongooseAdmin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">ensureUserExists</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Users</span><span class="p">.</span><span class="nx">ensureExists</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">adminUser</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span><span class="p">)</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;\x1b[36mformage\x1b[0m user: %s&#39;</span><span class="p">,</span> <span class="nx">adminUser</span><span class="p">.</span><span class="nx">username</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> api public</span></p>

<p>Log in as a user</p>

<p>Parameters:</p>

<ul>
<li><p><strong>username must be a String.</strong></p></li>
<li><p><strong>password must be a String.</strong></p></li>
<li><p><strong>onReady must be a Function.</strong></p></li>
</ul></div></div><div class="code"><div class="wrapper"><span class="nx">MongooseAdmin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">login</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">onReady</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Users</span><span class="p">.</span><span class="nx">getByUsernamePassword</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">adminUser</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">onReady</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">adminUser</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">};</span>


<span class="nx">MongooseAdmin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">registerAdminUserModel</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span><span class="nx">options</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">registerMongooseModel</span><span class="p">(</span><span class="nx">name</span> <span class="o">||</span> <span class="s1">&#39;Admin Users&#39;</span><span class="p">,</span> <span class="nx">Users</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">form</span><span class="o">:</span><span class="nx">exports</span><span class="p">.</span><span class="nx">AdminUserForm</span><span class="p">,</span>
        <span class="nx">list</span><span class="o">:</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span>
        <span class="nx">order_by</span><span class="o">:</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span>
    <span class="p">},</span><span class="nx">options</span><span class="o">||</span><span class="p">{}));</span>
<span class="p">};</span></div></div></div></div></body></html>